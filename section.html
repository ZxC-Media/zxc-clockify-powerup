<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<base target="_top">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://p.trellocdn.com/power-up.min.js"></script>
<title>ZxC Timer</title>
<style>
  :root{--bg:#ffffff;--muted:#6b7280;--accent:#0f766e;--accent-600:#0b6a64;--danger:#ef4444;--card-shadow:0 6px 18px rgba(15,23,42,0.06);--radius:10px;}
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Roboto","Oxygen","Ubuntu","Cantarell","Fira Sans","Droid Sans","Helvetica Neue",sans-serif;background:transparent;color:#0f172a;-webkit-font-smoothing:antialiased;}
  .container{padding:14px;width:320px;box-sizing:border-box;}
  .card{background:var(--bg);border-radius:var(--radius);padding:12px;box-shadow:var(--card-shadow);border:1px solid rgba(15,23,42,0.04);}
  .header{display:flex;gap:8px;align-items:center;justify-content:space-between;}
  .title{display:flex;gap:10px;align-items:center;min-width:0;}
  .project-dot{width:12px;height:12px;border-radius:50%;background:var(--accent);flex:0 0 12px;box-shadow:0 1px 0 rgba(0,0,0,0.06) inset;}
  .title h3{margin:0;font-size:14px;font-weight:600;line-height:1;color:#071133;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .subtitle{margin:0;font-size:12px;color:var(--muted);}
  .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
  .stat{background:linear-gradient(180deg,rgba(250,250,251,1),rgba(243,244,246,1));border-radius:8px;padding:8px;display:flex;flex-direction:column;gap:4px;align-items:flex-start;}
  .stat .label{font-size:11px;color:var(--muted);}
  .stat .value{font-size:15px;font-weight:700;color:#0f172a;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono","Courier New",monospace;}
  .controls{display:flex;gap:8px;margin-top:12px;align-items:center;justify-content:space-between;}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:10px;border:none;font-weight:600;cursor:pointer;font-size:13px;box-shadow:0 4px 12px rgba(2,6,23,0.06);}
  .btn:disabled{opacity:0.7;cursor:wait;transform:none;box-shadow:none;}
  .btn-start{background:linear-gradient(180deg,var(--accent),var(--accent-600));color:white;}
  .btn-stop{background:#fff;color:var(--danger);border:1px solid rgba(239,68,68,0.12);}
  .running-dot{width:10px;height:10px;border-radius:50%;background:#22c55e;box-shadow:0 0 6px rgba(34,197,94,0.28);display:inline-block;vertical-align:middle;margin-right:6px;}
  .small{font-size:12px;color:var(--muted);}
  .error{margin-top:10px;background:#fff7f7;border:1px solid #ffdede;color:#7c0b0b;padding:8px;border-radius:8px;font-size:12px;display:none;}
  .hint{margin-top:8px;font-size:11px;color:var(--muted);}
</style>
</head>
<body>
  <div class="container">
    <div class="card" role="region" aria-label="ZxC Clockify Timer">
      <div class="header">
        <div class="title">
          <div class="project-dot" aria-hidden="true"></div>
          <div style="min-width:0;">
            <h3 id="card-title">Loading…</h3>
            <div class="subtitle" id="card-sub">Trello Card</div>
          </div>
        </div>
        <div id="state-indicator" class="small" aria-live="polite">Idle</div>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="label">Total Logged</div>
          <div class="value" id="total-time">--:--:--</div>
        </div>
        <div class="stat">
          <div class="label">Entries</div>
          <div class="value" id="entry-count">0</div>
        </div>
      </div>
      <div class="controls">
        <button id="startBtn" class="btn btn-start" title="Start timer"><svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M8 5v14l11-7z"/></svg> <span id="startLabel">Start</span></button>
        <button id="stopBtn" class="btn btn-stop" title="Stop timer" style="display:none;"><svg width="14" height="14" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M6 6h12v12H6z"/></svg> <span id="stopLabel">Stop</span></button>
        <div id="live" class="small" aria-live="polite">—</div>
      </div>
      <div id="error" class="error" style="display:none;"></div>
      <div class="hint">Note: Timer actions may take up to a minute to process.</div>
    </div>
  </div>

<script>
  const ZXC_BLOCK_START = '--- ZxC Sync ---';
  const t = TrelloPowerUp.iframe();
  let liveInterval = null;

  // --- UTILITIES ---
  function formatTime(s){const h=String(Math.floor(s/3600)).padStart(2,'0'),m=String(Math.floor(s%3600/60)).padStart(2,'0'),c=String(Math.floor(s%60)).padStart(2,'0');return`${h}:${m}:${c}`}
  function showError(m){const e=document.getElementById('error');e.textContent=m;e.style.display=m?'block':'none'}
  function setLoading(l){document.getElementById('startBtn').disabled=l;document.getElementById('stopBtn').disabled=l}
  function parseZxCBlock(text){if(!text)return null;const s=text.indexOf(ZXC_BLOCK_START);if(s===-1)return null;const n=text.substring(s+ZXC_BLOCK_START.length).trim(),o={};n.split(/\r?\n/).forEach(t=>{const n=t.match(/^([\w]+):\s*(.+)$/);n&&(o[n[1]]=n[2])});return o}
  function updateUIState({running:r,startTimeIso:t}){document.getElementById('startBtn').style.display=r?'none':'inline-flex';document.getElementById('stopBtn').style.display=r?'inline-flex':'none';document.getElementById('state-indicator').innerHTML=r?'<span class="running-dot"></span>Running':'Idle';if(r&&t)startLiveTimer(t);else stopLiveTimer()}
  function startLiveTimer(t){stopLiveTimer();if(!t)return;liveInterval=setInterval(()=>{const s=Math.floor((Date.now()-new Date(t).getTime())/1000);document.getElementById('live').textContent='Elapsed: '+formatTime(s)},1000)}
  function stopLiveTimer(){if(liveInterval){clearInterval(liveInterval);liveInterval=null}document.getElementById('live').textContent='—'}

  // --- HANDLERS (These now just set a flag in Power-Up data) ---
  async function handleStartClick() {
    setLoading(true);
    await t.set('card', 'shared', 'zxc_action', { zxc_action: { action: 'start', timestamp: Date.now() } });
    t.alert({ message: 'Start command sent! Processing shortly.', duration: 3 });
    // Optimistically update the UI to feel instant
    updateUIState({ running: true, startTimeIso: new Date().toISOString() });
    setLoading(false);
  }
  async function handleStopClick() {
    setLoading(true);
    await t.set('card', 'shared', 'zxc_action', { zxc_action: { action: 'stop', timestamp: Date.now() } });
    t.alert({ message: 'Stop command sent! Processing shortly.', duration: 3 });
    // Optimistically update the UI
    updateUIState({ running: false });
    setLoading(false);
  }

  // --- INITIAL RENDER ---
  t.render(async () => {
    try {
      const card = await t.card('name', 'desc', 'shortLink');
      document.getElementById('card-title').textContent = card.name || 'Untitled Card';
      document.getElementById('card-sub').textContent = 'card • ' + (card.shortLink || '');
      
      const block = parseZxCBlock(card.desc);
      updateUIState({ running: !!block, startTimeIso: block ? block.TimestampStarted : null });

      // NOTE: With the trigger model, live summary data is not available.
      // This data will be updated on the card description by the backend sync.
      document.getElementById('total-time').textContent = '...';
      document.getElementById('entry-count').textContent = '...';
      
      await t.sizeTo(document.body);
    } catch (e) {
      showError('Failed to render card details.');
    }
  });

  document.getElementById('startBtn').addEventListener('click', handleStartClick);
  document.getElementById('stopBtn').addEventListener('click', handleStopClick);
  window.addEventListener('unload', () => { if (liveInterval) clearInterval(liveInterval); });
</script>
</body>
</html>
